<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>ABR Test Runner</title>
    <meta name="description" content="" />

    <script src="MetricSet.js"></script>
    <script src="SessionInfo.js"></script>
    <script src="Metrics.js"></script>

    <script src="dash.js/dist/dash.all.debug.js"></script>



    <script>

        var MPDS_JSON_FILE_PATH = 'mpds.json',
            controlbar,
            player,
            mpds = null,
            nextMpdIndex = 0,
            testTimeout = NaN,
            metrics = null,
            currentSessionInfo = null;



        function init() {

            player = dashjs.MediaPlayer().create();
            player.initialize(document.getElementById('video'), null, true);

            player.on(dashjs.MediaPlayer.events.PLAYBACK_STARTED, onPlaybackStarted);
            player.on(dashjs.MediaPlayer.events.PLAYBACK_ENDED, onPlaybackEnded);
            player.on(dashjs.MediaPlayer.events.PLAYBACK_ERROR, onError);
            player.on(dashjs.MediaPlayer.events.ERROR, onError);

            player.on(dashjs.MediaPlayer.events.BUFFER_LEVEL_STATE_CHANGED, onBufferStateChange);
            player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_START, onQualityChanged);


            metrics = new Metrics();

            //Load playlist and start test
            var xhr = new XMLHttpRequest();
            xhr.overrideMimeType("application/json");
            xhr.open('GET', MPDS_JSON_FILE_PATH);
            xhr.onreadystatechange = function() {
                // TODO: check for errors
                if (xhr.readyState === 4 && xhr.status === 200) {
                    mpds = JSON.parse(xhr.responseText).mpds;
                    next();
                }
            };
            xhr.send();
        }

        function next() {
            stopTestTimeout();

            var mpdObj = getNextMpdObj();
            if (mpdObj) {

                currentSessionInfo = new SessionInfo();
                currentSessionInfo.time = performance.now();
                currentSessionInfo.wallclockTime = Date.now();
                currentSessionInfo.mpd = mpdObj.url;
                currentSessionInfo.id = getGUID();
                currentSessionInfo.abr = mpdObj.abr;
                currentSessionInfo.fastSwitch = mpdObj.fastSwitch;

                metrics.createSession(currentSessionInfo);

                player.enableBufferOccupancyABR(currentSessionInfo.abr === 'bola');
                player.setFastSwitchEnabled(currentSessionInfo.fastSwitch);
                player.attachSource(mpdObj.url);

                startTestTimeout(mpdObj.test_duration * 1000);

            }
        }

        function getNextMpdObj() {
            if (!mpds || mpds.length < 1) {
                return null;
            }
            if (nextMpdIndex >= mpds.length) {
                nextMpdIndex = 0;
            }
            var mpd = mpds[nextMpdIndex];
            ++nextMpdIndex;
            return mpd;
        }

        function startTestTimeout(delayMs) {
            stopTestTimeout();
            testTimeout = setTimeout(function () {
                testTimeout = null;
                singleEnded("ended:timeout")
            }, delayMs);
        }

        function stopTestTimeout() {
            if (testTimeout) {
                clearTimeout(testTimeout);
            }
            testTimeout = null;
        }

        ////////////////////////////////////////////////
        /// EVENTS & METRICS
        ////////////////////////////////////////////////

        function onBufferStateChange(e) {
            if (e.mediaType === 'video') {
                var metricSet = new MetricSet();
                metricSet.eventType = e.state;
                captureMetricSet(metricSet);
            }
        }

        function onQualityChanged(e) {
            if (e.mediaType === 'video') {
                var metricSet = new MetricSet();
                metricSet.eventType = e.type;
                metricSet.lastQualityLoaded = e.oldQuality;
                metricSet.nextQualityLoading = e.newQuality;
                metricSet.isUpShiftInQuality = e.oldQuality < e.newQuality;
                metricSet.bandwidth = "we need bandwidth from event please";
                captureMetricSet(metricSet);
            }
        }

        function captureMetricSet(metricSet) {
            metricSet.eventTime = performance.now();
            metricSet.wallclockTime = Date.now();
            metricSet.sessionInfo = currentSessionInfo;
            metricSet.bufferLevel = player.getBufferLength();
            metricSet.playheadTime = player.time();
            metricSet.lastQualityLoaded = isNaN(metricSet.lastQualityLoaded) ? player.getQualityFor('video') : metricSet.lastQualityLoaded;
            metrics.push(currentSessionInfo.id, metricSet);
        }

        function onPlaybackEnded(e) {
            singleEnded(e.type)
        }

        function singleEnded(type) {
            var metricSet = new MetricSet();
            metricSet.eventType = type;
            captureMetricSet(metricSet);
            next();
        }

        function onPlaybackStarted(e) {
            var metricSet = new MetricSet();
            metricSet.eventType = e.type;
            captureMetricSet(metricSet);
        }

        function onError(e) {
            var metricSet = new Metrics();
            metricSet.eventType = e.type;
            //Need more error info here.
            captureMetricSet(metricSet);
            player.reset();
            next();
        }

        function getGUID() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
        }

    </script>

    <style>
        video {
            width: 100%;
            height: 100%;
        }
    </style>

    <body onload="init()" style="background-color:#000000">
        <video id="video" controls> </video>
    </body>
</html>
